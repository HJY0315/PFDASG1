@model IEnumerable<PFDASG1.Models.Transactions>
@using Microsoft.AspNetCore.Http
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor


@{
    
    int userid = 0;
    if (HttpContextAccessor.HttpContext != null)
    {
        userid = HttpContextAccessor.HttpContext.Session.GetInt32("id") ?? 0;
  
    }
    Layout = "~/Views/Shared/_Layout.cshtml";
    // Check if Context and Session are not null
    var fontSize = Context?.Session?.GetInt32("FontSize") ?? 20;
}

<!--
    Keyboard shortcut & Voice Command guide:
    1. Create a floating button for user to click.
    2. Ensure that the button has the keyboard icon.
    3. Click the button to display keyboard shortcut and voice command.
    4. Create few shortcuts key to tryout.
    5. Type out the remaining shortcuts.
    6. Done
-->

<!DOCTYPE html>
<html>
<head>
    <!-- Use Unicode character encoding - multi-language compatibility -->
    <meta charset="utf-8">

    <!-- Set the initial view zooming scale for mobile device -->
    <meta name="viewport" content="width = device-width,
 initial-scale = 1" />

    <title>OCBC - User Homepage</title>

    <!-- Reference to customized styling for this website -->
    @*<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />*@
    <link rel="stylesheet" type="text/css" href="~/css/site.css">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.syncfusion.com/ej2/xx.x.x/dist/ej2.min.css" />


    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    
    <!-- Bootstrap JavaScript (Popper.js is required for dropdowns) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>

    @{
        // Check if Context and Session are not null
        //var fontSize = Context?.Session?.GetInt32("FontSize") ?? 20;
    }

    <style>
        body {
            font-size: @(fontSize)px;
        }
    </style>
</head>

<body>
    <header>
        <partial name="_navbar" />
    </header>

    @*Summary Widgets*@
    <div class="row mb-4">

        <div class="col-md-4">
            <div class="d-flex flex-row widget summary income">
                <div class="d-flex flex-column justify-content-center p-4">
                    <i class="fa fa-dollar" style="font-size:60px;color:green;text-shadow:2px 2px 4px #000000;"></i>
                </div>
                <div class="d-flex flex-column m-auto py-4">
                    <span class="lead">Monthly Income</span>
                    <p class="display-6 fw-bold">@ViewBag.totalBalance</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="d-flex flex-row widget summary expense">
                <div class="d-flex flex-column justify-content-center p-4">
                    <i class="fa fa-dollar" style="font-size:60px;color:red;text-shadow:2px 2px 4px #000000;"></i>
                </div>
                <div class="d-flex flex-column m-auto py-4">
                    <span class="lead">Monthly Expense</span>
                    <p class="display-6 fw-bold">@ViewBag.amountToSubtract</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="d-flex flex-row widget summary balance">
                <div class="d-flex flex-column justify-content-center p-4">
                    <i class="fa fa-dollar" style="font-size:60px;color:blue;text-shadow:2px 2px 4px #000000;"></i>
                </div>
                <div class="d-flex flex-column m-auto py-4">
                    <span class="lead">Balance</span>
                    <p class="display-6 fw-bold">@ViewBag.Balance</p>
                </div>
            </div>
        </div>
    </div>

    @*Doughnut and Spline Chart*@
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="widget chart">
                <div class="p-4">
                    <p class="fw-bold">Expense By Month</p>
                </div>
                <div>
                    <canvas id="doughnutChart"></canvas>
                </div>

            </div>
        </div>
        @*Recent Transactions and More*@
        <div class="col-md-7">
        <div class="widget chart">
            <div class="p-4">
                    <p class="fw-bold">Recent Transactions</p>
            </div>
                <div class="flex-table">
                    <div class="flex-header">
                        <button class="filter-btn active" data-filter="all" aria-pressed="true">All</button>
                        <button class="filter-btn" data-filter="expense" aria-pressed="false">Expense</button>
                        <button class="filter-btn" data-filter="income" aria-pressed="false">Income</button>
                    </div>
                    <div class="header">
                        <div class="flex-cell">Date</div>
                        <div class="flex-cell">Description</div>
                        <div class="flex-cell">Amount</div>
                    </div>

                    @foreach (var item in ViewBag.RecentTransactions)
                    {
                        <div class="flex-row" data-type="@(item.RecipientID == @userid ? "income" : "expense")">
                            @*<div class="flex-cell">@item.RecipientID == @userid ? "Income" : "Expense"</div>*@
                            <div class="flex-cell">@item.TransactionDate.Date.ToString("yyyy-MM-dd")</div>
                            <div class="flex-cell">@item.Description</div>
                            <div class="flex-cell" style="color: @(item.RecipientID == @userid ? "green" : "red"); font-weight:bold;">
                                @(item.RecipientID == @userid ? "+" : "-")@item.Amount.ToString("0.00")
                            </div>
                        </div>
                    }
                </div>
        </div>
    </div>
    </div>

    <footer>
        <p>&copy; Please do not share or download your information.</p>
    </footer>

    <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Get data from ViewBag.DoughnutChartData
                var chartData = @Html.Raw(Json.Serialize(ViewBag.DoughnutChartData));

                // Extract labels and data from the chartData
            var labels = chartData.map(function (item) {
                return item.TransactionDate;
            });

                var data = chartData.map(function (item) {
                    return item.amount;
                });

                // Create the doughnut chart
                var ctx = document.getElementById("doughnutChart").getContext("2d");
                var doughnutChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ["#0e8d76", "#a4b219", "#cb9b00", "#8a442c", "#0454b5", "#7d0a0a", "#822690", "#4c2090", "#313e93", "#0096ac"]
                        }]
                    },
                    options: {
                        legend: {
                            display: false
                        }
                    }
                });
            });


        const filterButtons = document.querySelectorAll('.filter-btn');
        const rowsToFilter = document.querySelectorAll('.flex-row');
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-pressed', 'false');
                });
                button.classList.add('active');
                button.setAttribute('aria-pressed', 'true');
                const filterValue = button.getAttribute('data-filter');
                rowsToFilter.forEach(row => {
                    const rowType = row.getAttribute('data-type');
                    if (filterValue === 'all') {
                        row.style.display = 'flex';
                    } else {
                        row.style.display = rowType === filterValue ? 'flex' : 'none';
                    }
                });
            });
        });
    </script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/search.js" asp-append-version="true"></script>
    <script src="~/js/annyang-setup.js" asp-append-version="true"></script>
    <script src="https://cdn.syncfusion.com/ej2/xx.x.x/dist/ej2.min.js"></script>

</body>
</html>